---
layout: post
title:  "맵리듀스 작동 방법"
date:   2019-04-16 00:40:21
categories: [DataScience]
comments: true
---


# 맵리듀스 작동 방법
## 맵리듀스 잡 실행 상세분석 

#### 맵리듀스 잡의 전체 과정
* job 객체의 submit() 메서드 호출로 맵리듀스 잡 실행 가능 (그림의 1번 과정) 
![image](https://user-images.githubusercontent.com/28076434/56142959-904d3900-5fda-11e9-8acc-007fbc29e789.png)

* 다섯 개의 독립적인 단계
1. 클라이언트 
-맵리듀스 잡을 제출
2. YARN 리소스 매니저 
-클러스터 상에 계산 리소스의 할당을 제어함
3. YARN 노드 매니저 
-클러스터의 각 머신에서 계산 컨테이너를 시작하고 모니터링함
4. 맵리듀스 애플리케이션 마스터 
-맵리듀스 잡을 수행하는 각 태스크를 제어함
-애플리케이션 마스터와 맵리듀스 태스크는 컨테이너 내에서 실행됨
-리소스 매니저는 잡을 할당하고 노드 매니저는 태스크를 관리함  
5. 분산 파일 시스템
-다른 단계 간에 잡 리소스 파일들을 공유함 (보통 HDFS 사용)


#### 잡 제출
* submit() 메서드는 내부의 JobSubmitter 인스턴스를 생성
* submitJobInternal() 메서드를 호출
* JobSubmitter의 잡 제출 과정
1. 리소스 매니저에 맵리듀스 잡 ID로 사용될 새로운 애플리케이션 ID를 요청
2. 잡의 출력 명세 확인(출력 디렉터리가 지정되지 않았거나 이미 존재한다면 해당 잡은 제출되지 않고 MR프로그램에 에러를 전달함)
3. 잡의 입력 스플릿을 계산(스플릿을 계산할 수 없다면 MR프로그램에 에러를 전달함)
4. 잡 실행에 필요한 잡 JAR파일, 환경 설정 파일, 계산된 입력 스플릿 등의 잡 리소스를 HDFS와 같은 공유 파일 시스템에 있는 해당 잡 ID 이름의 디렉터리에 복사함
5. 리소스 매니저의 submitApplication()을 호출하여 잡을 
* 일단 잡을 제출하면 waitForCompletion() 메서드가 1초에 한 번씩 잡의 진행상황을 조사, 변경 내역은 콘솔로 보여줌
* 잡이 성공적으로 완료되면 잡 카운터를 보여줌

#### 잡 초기화
* 리소스 매니저가 submitApplication() 메서드의 호출을 받으면 YARN 스케줄러에 요청을 전달함
* 스케줄러는 컨테이너를 하나 할당하고, 리소스 매니저는 노드 매니저의 운영 규칙에 따라 애플리케이션 마스터 프로세스를 시작함
* 애플리케이션 마스터
1. 자바 애플리케이션이며 메인 클래스는 MRAppMaster
2. 잡을 초기화할 때 잡의 진행 상태를 추적하기 위한 다수의 북키핑 객체를 생성 후, 이후 각 태스크로부터 진행 및 종료 보고서를 받음
3. 클라이언트가 계산한 입력 스플릿 정보를 공유 파일시스템에서 읽어옴
4. 입력 스플릿 별로 맵 태스크 객체를 생성하고 mapreduce.job.reduces 속성의 값(리듀서 수)만큼 객체를 생성하여 각 태스크는 ID를 부여받음
5. 잡을 구성하는 태스크를 실행하는 방법을 결정해야 함
-잡의 크기가 작다면 자신의 JVM에서 실행할 수도 있음. 이러한 잡을 우버태스크로 실행된다고 함 
-우버 태스크 : 애플리케이션 마스터 내의 맵리듀스에서 실행되는 것으로 별도의 컨테이너를 생성하지 않아 오버헤드를 줄일 수 있음 
-작은 잡이란 보통 10개 미만의 매퍼와 하나의 리듀서, HDFS 블록 하나보다 작은 크기의 입력을 말함 
-우버 태스크는 반드시 mapreduce.job.ubertask.enable속성을 true로 변경하여 활성화해야 함
6. 태스크를 실행하기 전 OutputCommitter의 setupJob() 메서드를 호출하여 잡의 최종 출력 디렉터리와 태스크 출력을 위한 임시 작업 공간을 생성함

#### 태스크 
